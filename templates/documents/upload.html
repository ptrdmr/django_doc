{% extends "base.html" %}

{% block title %}Upload Medical Document{% endblock %}

{% block extra_css %}
<!-- Tom Select for searchable dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet" 
      onerror="this.href='https://unpkg.com/tom-select@2.3.1/dist/css/tom-select.css'">
<style>
    .ts-control {
        border: 1px solid #d1d5db !important;
        border-radius: 0.5rem !important;
        padding: 0.5rem 0.75rem !important;
    }
    .ts-control.focus {
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5) !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Tom Select JavaScript - load before other scripts -->
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js" 
        onerror="this.src='https://unpkg.com/tom-select@2.3.1/dist/js/tom-select.complete.min.js'"></script>
{% endblock %}

{% block content %}
<div class="p-6" x-data="documentUpload()">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex items-center space-x-3 mb-4">
            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Upload Medical Document</h1>
                <p class="text-gray-600">Upload PDF documents for AI processing and FHIR data extraction</p>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-blue-800">Available Patients</p>
                        <p class="text-lg font-bold text-blue-900">{{ patient_count }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-green-800">Success Rate</p>
                        <p class="text-lg font-bold text-green-900">{{ upload_stats.success_rate }}%</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-purple-800">Total Documents</p>
                        <p class="text-lg font-bold text-purple-900">{{ upload_stats.total }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Form -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Main Upload Form -->
        <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
            <div class="p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Document Upload</h2>
                
                <form method="post" enctype="multipart/form-data" @submit="handleSubmit">
                    {% csrf_token %}
                    
                    <!-- Patient Selection -->
                    <div class="mb-6">
                        <label for="{{ form.patient.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Patient *
                        </label>
                        {{ form.patient }}
                        {% if form.patient.errors %}
                            <div class="mt-1 text-sm text-red-600">
                                {{ form.patient.errors.0 }}
                            </div>
                        {% endif %}
                        {% if form.patient.help_text %}
                            <p class="mt-1 text-sm text-gray-500">{{ form.patient.help_text }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- File Upload -->
                    <div class="mb-6">
                        <label for="{{ form.file.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Document File *
                        </label>
                        
                        <!-- File Upload Button -->
                        <div class="flex items-center space-x-4">
                            <button 
                                type="button" 
                                id="upload-button"
                                onclick="document.getElementById('{{ form.file.id_for_label }}').click();"
                                class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                            >
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Choose PDF File
                            </button>
                            
                            <!-- Selected File Display -->
                            <div id="file-display" class="flex items-center space-x-3" style="display: none;">
                                <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <div class="text-left">
                                    <p id="file-name" class="text-sm font-medium text-gray-900"></p>
                                    <p id="file-size" class="text-xs text-gray-500"></p>
                                </div>
                                <button type="button" onclick="clearFile()" class="text-red-600 hover:text-red-800">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- File Input -->
                        <input 
                            type="file" 
                            x-ref="fileInput"
                            id="{{ form.file.id_for_label }}"
                            name="{{ form.file.name }}"
                            accept=".pdf"
                            class="hidden"
                            @change="handleFileSelect"
                            onchange="handleFileChange(this)"
                        />
                        
                        <p class="mt-2 text-xs text-gray-500">PDF files only, up to 50MB</p>
                        
                        {% if form.file.errors %}
                            <div class="mt-2 text-sm text-red-600">
                                {{ form.file.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Provider Selection -->
                    <div class="mb-6">
                        <label for="{{ form.providers.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Associated Providers
                        </label>
                        {{ form.providers }}
                        {% if form.providers.errors %}
                            <div class="mt-1 text-sm text-red-600">
                                {{ form.providers.errors.0 }}
                            </div>
                        {% endif %}
                        {% if form.providers.help_text %}
                            <p class="mt-1 text-sm text-gray-500">{{ form.providers.help_text }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Notes -->
                    <div class="mb-6">
                        <label for="{{ form.notes.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Notes
                        </label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                            <div class="mt-1 text-sm text-red-600">
                                {{ form.notes.errors.0 }}
                            </div>
                        {% endif %}
                        {% if form.notes.help_text %}
                            <p class="mt-1 text-sm text-gray-500">{{ form.notes.help_text }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Form-wide Errors -->
                    {% if form.non_field_errors %}
                        <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-red-800">Upload Error</h3>
                                    <div class="mt-2 text-sm text-red-700">
                                        {% for error in form.non_field_errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Submit Button -->
                    <div class="flex justify-end">
                        <button 
                            type="submit" 
                            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
                            :disabled="uploading || !selectedFile"
                            :class="{ 'opacity-50 cursor-not-allowed': uploading || !selectedFile }"
                        >
                            <svg x-show="uploading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span x-text="uploading ? 'Uploading...' : 'Upload Document'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Recent Uploads Sidebar -->
        <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
            <div class="p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Recent Uploads</h2>
                
                {% if recent_uploads %}
                    <div class="space-y-4">
                        {% for upload in recent_uploads %}
                            <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center
                                        {% if upload.status == 'completed' %}bg-green-100 text-green-600
                                        {% elif upload.status == 'failed' %}bg-red-100 text-red-600
                                        {% elif upload.status == 'processing' %}bg-blue-100 text-blue-600
                                        {% else %}bg-gray-100 text-gray-600{% endif %}">
                                        {% if upload.status == 'completed' %}
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                            </svg>
                                        {% elif upload.status == 'failed' %}
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                            </svg>
                                        {% elif upload.status == 'processing' %}
                                            <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                            </svg>
                                        {% else %}
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                            </svg>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">{{ upload.filename }}</p>
                                    <p class="text-xs text-gray-500">{{ upload.patient.first_name }} {{ upload.patient.last_name }}</p>
                                    <p class="text-xs text-gray-400">{{ upload.uploaded_at|date:"M j, g:i A" }}</p>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-8">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M34 40h10v-4a6 6 0 00-10.712-3.714M34 40H14m20 0v-4a9.971 9.971 0 00-.712-3.714M14 40H4v-4a6 6 0 0110.713-3.714M14 40v-4c0-1.313.253-2.566.713-3.714m0 0A9.971 9.971 0 0124 24c4.21 0 7.813 2.602 9.288 6.286M30 14a6 6 0 11-12 0 6 6 0 0112 0zm12 6a4 4 0 11-8 0 4 4 0 018 0zm-28 0a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <p class="mt-2 text-sm text-gray-500">No recent uploads</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function documentUpload() {
    return {
        selectedFile: null,
        uploading: false,
        
        init() {
            // Initialize component
            console.log('Document upload initialized');
        },
        
        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.selectedFile = file;
                this.validateFile(file);
            }
        },
        
        validateFile(file) {
            // Check file type
            if (!file.type.includes('pdf') && !file.name.toLowerCase().endsWith('.pdf')) {
                this.showError('Please select a PDF file.');
                this.clearFile();
                return false;
            }
            
            // Check file size (50MB limit)
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                this.showError('File size exceeds 50MB limit.');
                this.clearFile();
                return false;
            }
            
            return true;
        },
        
        clearFile() {
            this.selectedFile = null;
            this.$refs.fileInput.value = '';
        },
        
        handleSubmit(event) {
            if (!this.selectedFile) {
                event.preventDefault();
                this.showError('Please select a file to upload.');
                return;
            }
            
            this.uploading = true;
            // Form will submit normally, uploading state will be reset on page reload
        },
        
        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        
        showError(message) {
            // Basic error display - could be enhanced with a toast notification system
            alert(message);
        }
    }
}

// Fallback JavaScript function for file selection
function handleFileChange(input) {
    const file = input.files[0];
    if (file) {
        // Basic validation first
        if (!file.type.includes('pdf') && !file.name.toLowerCase().endsWith('.pdf')) {
            alert('Please select a PDF file.');
            input.value = '';
            return;
        }
        
        const maxSize = 50 * 1024 * 1024; // 50MB
        if (file.size > maxSize) {
            alert('File size exceeds 50MB limit.');
            input.value = '';
            return;
        }
        
        // Show file name and size
        const fileName = file.name;
        const fileSize = formatFileSize(file.size);
        
        // Update the display elements
        const fileDisplay = document.getElementById('file-display');
        const fileNameEl = document.getElementById('file-name');
        const fileSizeEl = document.getElementById('file-size');
        
        if (fileDisplay && fileNameEl && fileSizeEl) {
            fileNameEl.textContent = fileName;
            fileSizeEl.textContent = fileSize;
            fileDisplay.style.display = 'flex';
        }
        
        console.log('File selected:', fileName, fileSize);
    }
}

function clearFile() {
    const fileInput = document.querySelector('input[type="file"]');
    const fileDisplay = document.getElementById('file-display');
    
    if (fileInput) {
        fileInput.value = '';
    }
    
    if (fileDisplay) {
        fileDisplay.style.display = 'none';
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Initialize Tom Select for searchable dropdowns
function initializeTomSelect() {
    console.log('=== TomSelect Initialization Debug ===');
    
    // Check if Tom Select is available
    if (typeof TomSelect === 'undefined') {
        console.error('❌ TomSelect is not loaded! Check CDN connection.');
        // Try to load from alternative CDN
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/tom-select@2.3.1/dist/js/tom-select.complete.min.js';
        script.onload = function() {
            console.log('✅ TomSelect loaded from backup CDN');
            initializeTomSelect(); // Retry initialization
        };
        script.onerror = function() {
            console.error('❌ Failed to load TomSelect from backup CDN');
        };
        document.head.appendChild(script);
        return;
    }
    
    console.log('✅ TomSelect is available:', TomSelect);
    
    // Initialize patient select
    const patientSelect = document.getElementById('patient-select');
    console.log('Patient select element:', patientSelect);
    
    if (patientSelect) {
        console.log('🔧 Initializing patient select...');
        console.log('Patient select options count:', patientSelect.options.length);
        
        try {
            const patientTomSelect = new TomSelect(patientSelect, {
                create: false,
                sortField: 'text',
                placeholder: 'Search for a patient...',
                searchField: ['text'],
                maxOptions: 50,
                plugins: {
                    clear_button: {
                        title: 'Clear selection'
                    }
                }
            });
            console.log('✅ Patient select initialized successfully:', patientTomSelect);
        } catch (error) {
            console.error('❌ Error initializing patient select:', error);
            console.error('Error stack:', error.stack);
        }
    } else {
        console.error('❌ Patient select element not found! Looking for #patient-select');
        // Debug: show all select elements
        const allSelects = document.querySelectorAll('select');
        console.log('All select elements found:', allSelects);
        allSelects.forEach((select, index) => {
            console.log(`Select ${index}:`, select.id, select.name, select);
        });
    }
    
    // Initialize provider select
    const providerSelect = document.getElementById('provider-select');
    console.log('Provider select element:', providerSelect);
    
    if (providerSelect) {
        console.log('🔧 Initializing provider select...');
        console.log('Provider select options count:', providerSelect.options.length);
        
        try {
            const providerTomSelect = new TomSelect(providerSelect, {
                create: false,
                sortField: 'text',
                placeholder: 'Search for providers...',
                searchField: ['text'],
                maxOptions: 50,
                plugins: {
                    remove_button: {
                        title: 'Remove this provider'
                    },
                    clear_button: {
                        title: 'Clear all providers'
                    }
                }
            });
            console.log('✅ Provider select initialized successfully:', providerTomSelect);
        } catch (error) {
            console.error('❌ Error initializing provider select:', error);
            console.error('Error stack:', error.stack);
        }
    } else {
        console.error('❌ Provider select element not found! Looking for #provider-select');
        // Debug: show all select elements
        const allSelects = document.querySelectorAll('select');
        console.log('All select elements found:', allSelects);
        allSelects.forEach((select, index) => {
            console.log(`Select ${index}:`, select.id, select.name, select);
        });
    }
    
    console.log('=== TomSelect Initialization Complete ===');
}

// Multiple initialization attempts for reliability
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM loaded, attempting TomSelect initialization...');
    initializeTomSelect();
});

// Fallback initialization after a short delay
setTimeout(function() {
    console.log('⏱️ Fallback initialization after 1 second...');
    initializeTomSelect();
}, 1000);
</script>
{% endblock %} 