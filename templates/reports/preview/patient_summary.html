{% extends "base.html" %}
{% load static %}

{% block title %}{{ title|default:"Patient Summary Report" }} - Preview{% endblock %}

{% block extra_css %}
<style>
    /* Preview Container */
    .preview-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* Action Bar */
    .preview-actions {
        background: white;
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .preview-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
    }
    
    .btn-download {
        background: #2563eb;
        color: white;
        padding: 10px 20px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
    }
    
    .btn-download:hover {
        background: #1e40af;
        color: white;
    }
    
    .btn-back {
        background: #f1f5f9;
        color: #475569;
        padding: 10px 20px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        transition: background 0.2s;
    }
    
    .btn-back:hover {
        background: #e2e8f0;
        color: #475569;
    }
    
    /* Report Display */
    .report-display {
        background: #f5f5f5;
        padding: 40px 20px;
        border-radius: 8px;
    }
    
    /* Dashboard Styles (matching PDF) */
    .dashboard {
        max-width: 8.5in;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 4px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    
    h1 {
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 28px;
        font-weight: 600;
    }
    
    .generated-date {
        font-size: 11px;
        color: #666;
        margin-bottom: 20px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e0e0e0;
    }
    
    .section {
        margin-bottom: 25px;
        padding: 20px;
        background: #fafafa;
        border-radius: 6px;
        border-left: 4px solid #4a90e2;
    }
    
    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }
    
    .section-number {
        background: #4a90e2;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-size: 14px;
        font-weight: 600;
        flex-shrink: 0;
    }
    
    .field-list {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 10px;
    }
    
    .field {
        padding: 10px 12px;
        background: white;
        border-radius: 4px;
        border: 1px solid #e0e0e0;
        font-size: 13px;
        color: #555;
    }
    
    .field strong {
        color: #333;
        font-weight: 600;
    }
    
    .comorbidities-list {
        margin-top: 12px;
        padding: 10px 12px;
        background: white;
        border-radius: 4px;
        border: 1px solid #e0e0e0;
        font-size: 13px;
        color: #555;
    }
    
    .table-container {
        background: white;
        border-radius: 4px;
        border: 1px solid #e0e0e0;
        padding: 10px;
        margin-top: 10px;
    }
    
    .table-row {
        padding: 10px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 13px;
        color: #666;
        line-height: 1.6;
    }
    
    .table-row:last-child {
        border-bottom: none;
    }
    
    .table-row strong {
        color: #333;
        font-weight: 600;
    }
    
    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 4px;
        border: 1px solid #e0e0e0;
        margin-top: 10px;
    }
    
    .empty-state {
        font-size: 13px;
        color: #888;
        font-style: italic;
        padding: 15px;
        text-align: center;
        background: white;
        border-radius: 4px;
        margin-top: 10px;
    }
    
    .note {
        font-size: 11px;
        color: #888;
        font-style: italic;
        margin-top: 8px;
    }
    
    .report-footer {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 2px solid #ddd;
        font-size: 9px;
        color: #666;
        line-height: 1.4;
    }
</style>
{% endblock %}

{% block content %}
<div class="preview-container">
    <!-- Action Bar -->
    <div class="preview-actions">
        <h1 class="preview-title">üìÑ Report Preview</h1>
        <div class="action-buttons">
            <a href="{% url 'reports:dashboard' %}" class="btn-back">
                ‚Üê Back to Reports
            </a>
            <a href="{% url 'reports:download' report.pk %}" class="btn-download">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
                Download PDF
            </a>
        </div>
    </div>
    
    <!-- Report Display -->
    <div class="report-display">
        <div class="dashboard">
            <!-- HEADER -->
            <h1>{{ title|default:"Patient Summary Report" }}</h1>
            <div class="generated-date">Generated: {{ generated_at|date:"m/d/Y" }}</div>
            
            <!-- SECTION 1: Demographics & Context -->
            <div class="section">
                <div class="section-title">
                    <span class="section-number">1</span>
                    Demographics & Context
                </div>
                <div class="field-list">
                    <div class="field"><strong>Age:</strong> {{ data.patient_info.age|default:"N/A" }}</div>
                    <div class="field"><strong>Gender:</strong> {{ data.patient_info.gender|default:"N/A" }}</div>
                    <div class="field">
                        <strong>Primary Diagnosis:</strong><br>
                        {% if data.patient_info.primary_diagnosis %}
                            {{ data.patient_info.primary_diagnosis.display_name|default:"N/A" }}
                        {% else %}
                            Not specified
                        {% endif %}
                    </div>
                    <div class="field">
                        <strong>ICD-10:</strong>
                        {% if data.patient_info.primary_diagnosis and data.patient_info.primary_diagnosis.codes.0.code %}
                            {{ data.patient_info.primary_diagnosis.codes.0.code }}
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                    <div class="field">
                        <strong>Date of Initial Diagnosis:</strong>
                        {% if data.patient_info.initial_diagnosis_date %}
                            {{ data.patient_info.initial_diagnosis_date|date:"m/d/Y" }}{% if data.patient_info.primary_diagnosis and data.patient_info.primary_diagnosis.onset_date_precision != 'day' %}*{% endif %}
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                    <div class="field"><strong>Current Living Setting:</strong> {{ data.patient_info.living_setting|default:"N/A" }}</div>
                </div>
                
                {% if data.patient_info.comorbidities %}
                <div class="comorbidities-list">
                    <strong>Comorbidities:</strong>
                    {% for condition in data.patient_info.comorbidities %}
                        {{ condition.display_name }}{% if not forloop.last %}; {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            <!-- SECTION 2: List of Diagnoses with Clinical Onset Dates -->
            <div class="section">
                <div class="section-title">
                    <span class="section-number">2</span>
                    List of Diagnoses with Clinical Onset Dates
                </div>
                
                {% if data.clinical_summary.conditions %}
                <div class="table-container">
                    {% for condition in data.clinical_summary.conditions %}
                    <div class="table-row">
                        <strong>{{ condition.display_name }}</strong> | 
                        ICD-10: {{ condition.codes.0.code|default:"Not coded" }} | 
                        Onset: {% if condition.onset_date %}{{ condition.onset_date|date:"m/d/Y" }}{% if condition.onset_date_precision != 'day' %}*{% endif %}{% else %}Not recorded{% endif %}
                        {% if condition.severity %} | Severity: {{ condition.severity }}{% endif %}
                    </div>
                    {% endfor %}
                </div>
                <div class="note">*Asterisk indicates approximate date (exact day unknown)</div>
                {% else %}
                <div class="empty-state">No diagnoses recorded</div>
                {% endif %}
            </div>
            
            <!-- SECTION 3: Weight Tracking -->
            <div class="section">
                <div class="section-title">
                    <span class="section-number">3</span>
                    Weight Tracking
                </div>
                
                {% if data.clinical_summary.weight_timeline.has_data %}
                <div class="chart-container">
                    <canvas id="weightChart" width="600" height="250"></canvas>
                </div>
                {% else %}
                <div class="empty-state">No weight data recorded</div>
                {% endif %}
            </div>
            
            <!-- SECTION 4: Hospitalizations -->
            <div class="section">
                <div class="section-title">
                    <span class="section-number">4</span>
                    Hospitalizations
                </div>
                
                {% if data.clinical_summary.encounters %}
                <div class="table-container">
                    {% for encounter in data.clinical_summary.encounters %}
                    <div class="table-row">
                        <strong>
                            {% if encounter.period.start %}{{ encounter.period.start|date:"m/d/Y" }}{% else %}Unknown{% endif %}
                            {% if encounter.period.end %} - {{ encounter.period.end|date:"m/d/Y" }}{% else %} - Ongoing{% endif %}
                        </strong> | 
                        Reason: {% if encounter.reason %}{% for r in encounter.reason|slice:":1" %}{{ r.display|default:r.code }}{% endfor %}{% else %}Not specified{% endif %} | 
                        Notes: {{ encounter.class|default:"Visit" }}
                        {% if encounter.location %} at {% for loc in encounter.location|slice:":1" %}{{ loc }}{% endfor %}{% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">No hospitalizations recorded</div>
                {% endif %}
            </div>
            
            <!-- SECTION 5: Labs -->
            <div class="section">
                <div class="section-title">
                    <span class="section-number">5</span>
                    Labs
                </div>
                
                {% if data.clinical_summary.observations %}
                <div class="table-container">
                    {% for obs in data.clinical_summary.observations %}
                    <div class="table-row">
                        <strong>{{ obs.display_name }}</strong> | 
                        Measurement: {{ obs.value|default:"‚Äî" }}{% if obs.unit %} {{ obs.unit }}{% endif %} | 
                        Date: {{ obs.effective_date|date:"m/d/Y"|default:"Not recorded" }}
                        {% if obs.interpretation %} | {{ obs.interpretation|join:", " }}{% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">No lab results recorded</div>
                {% endif %}
            </div>
            
            <!-- SECTION 6: Medications -->
            <div class="section">
                <div class="section-title">
                    <span class="section-number">6</span>
                    Medications
                </div>
                
                {% if data.clinical_summary.medications %}
                <div class="table-container">
                    {% for med in data.clinical_summary.medications %}
                    <div class="table-row">
                        <strong>{{ med.display_name }}</strong> | 
                        Dose: {% if med.dosage.0.text %}{{ med.dosage.0.text }}{% elif med.dosage.0.dose %}{{ med.dosage.0.dose }}{% else %}Not specified{% endif %} | 
                        Started: {{ med.effective_period.start|date:"m/d/Y"|default:"Unknown" }}
                        {% if med.status %} | Status: {{ med.status }}{% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">No medications recorded</div>
                {% endif %}
            </div>
            
            <!-- SECTION 7: Recent Procedures -->
            <div class="section">
                <div class="section-title">
                    <span class="section-number">7</span>
                    Procedures
                </div>
                
                {% if data.clinical_summary.procedures %}
                <div class="table-container">
                    {% for proc in data.clinical_summary.procedures %}
                    <div class="table-row">
                        <strong>{{ proc.display_name }}</strong> | 
                        Date: {{ proc.performed_date|date:"m/d/Y"|default:"Not recorded" }} | 
                        Notes: {{ proc.outcome|default:"Completed" }}
                        {% if proc.status %} ({{ proc.status }}){% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">No procedures recorded</div>
                {% endif %}
            </div>
            
            <!-- FOOTER -->
            <div class="report-footer">
                <p><strong>Disclaimer:</strong> This report is generated from structured clinical data for informational purposes only. 
                It contains PHI and should be handled in accordance with HIPAA regulations. 
                All data is proprietary to the healthcare institution and is intended for authorized personnel only.</p>
                <p style="margin-top: 10px;"><em>Generated: {{ generated_at|date:"F d, Y g:i A" }}</em></p>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js for Weight Chart -->
{% if data.clinical_summary.weight_timeline.has_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('weightChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ data.clinical_summary.weight_timeline.dates|safe }},
                datasets: [{
                    label: 'Weight ({{ data.clinical_summary.weight_timeline.unit }})',
                    data: {{ data.clinical_summary.weight_timeline.weights|safe }},
                    borderColor: '#4a90e2',
                    backgroundColor: 'rgba(74, 144, 226, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#4a90e2',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Weight ({{ data.clinical_summary.weight_timeline.unit }})'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}
