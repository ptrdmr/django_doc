{% extends "base.html" %}
{% load static %}

{% block title %}{{ title|default:"Patient Summary Report" }} - Preview{% endblock %}

{% block extra_css %}
<style>
    /* Preview Container */
    .preview-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* Action Bar */
    .preview-actions {
        background: white;
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .preview-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
    }
    
    .btn-download {
        background: #2563eb;
        color: white;
        padding: 10px 20px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
    }
    
    .btn-download:hover {
        background: #1e40af;
        color: white;
    }
    
    .btn-back {
        background: #f1f5f9;
        color: #475569;
        padding: 10px 20px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        transition: background 0.2s;
    }
    
    .btn-back:hover {
        background: #e2e8f0;
        color: #475569;
    }
    
    /* Report Display */
    .report-display {
        background: #f5f5f5;
        padding: 40px 20px;
        border-radius: 8px;
    }
    
    /* Reuse PDF styles for consistency */
    .report-container {
        display: flex;
        max-width: 8.5in;
        margin: 0 auto;
        background: white;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .content-area {
        flex: 1;
        padding: 40px 50px;
        background: white;
    }
    
    .navy-sidebar {
        width: 120px;
        background: linear-gradient(180deg, #001f54 0%, #003875 100%);
        position: relative;
    }
    
    /* Header Section */
    .report-header {
        margin-bottom: 30px;
    }
    
    .report-title {
        font-size: 36px;
        font-weight: bold;
        color: #001f54;
        margin: 0 0 5px 0;
        letter-spacing: -0.5px;
    }
    
    .generated-date {
        font-size: 12px;
        color: #666;
        margin-bottom: 20px;
        border-bottom: 3px solid #ff8c00;
        padding-bottom: 8px;
    }
    
    /* Patient Info Card */
    .patient-card {
        display: flex;
        align-items: center;
        margin-bottom: 25px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .icon-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #001f54;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 28px;
        margin-right: 15px;
        flex-shrink: 0;
    }
    
    .patient-details {
        flex: 1;
    }
    
    .patient-name {
        font-size: 16px;
        font-weight: bold;
        color: #001f54;
        margin: 0 0 3px 0;
    }
    
    .patient-meta {
        font-size: 12px;
        color: #666;
    }
    
    .patient-ids {
        text-align: right;
        font-size: 11px;
        color: #666;
        line-height: 1.6;
    }
    
    .patient-ids strong {
        color: #001f54;
    }
    
    /* Section with Icon Header */
    .section-with-icon {
        margin: 30px 0;
    }
    
    .section-icon-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .section-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #001f54;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        margin-right: 15px;
        flex-shrink: 0;
    }
    
    .section-title {
        font-size: 22px;
        font-weight: bold;
        color: #001f54;
        margin: 0;
        text-decoration: underline;
        text-decoration-color: #001f54;
        text-decoration-thickness: 2px;
        text-underline-offset: 4px;
    }
    
    /* Diagnosis List */
    .diagnosis-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .diagnosis-item {
        padding: 8px 0;
        font-size: 13px;
        line-height: 1.5;
    }
    
    .diagnosis-code {
        font-weight: bold;
        color: #001f54;
    }
    
    .diagnosis-name {
        color: #d9534f;
        font-weight: 500;
    }
    
    .diagnosis-inactive {
        color: #666;
    }
    
    /* Hospitalizations List */
    .hospitalization-list {
        margin: 0;
        padding-left: 20px;
    }
    
    .hospitalization-list li {
        margin-bottom: 12px;
        font-size: 12px;
        line-height: 1.6;
    }
    
    .hosp-date {
        font-weight: bold;
        color: #001f54;
    }
    
    /* Card Grid */
    .card-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-top: 20px;
    }
    
    .info-card {
        border: 3px solid #ff8c00;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .card-header {
        background: #ff8c00;
        color: white;
        padding: 10px 15px;
        font-size: 16px;
        font-weight: bold;
        display: flex;
        align-items: center;
    }
    
    .card-icon {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: #001f54;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        margin-right: 10px;
    }
    
    .card-body {
        padding: 15px;
        background: white;
    }
    
    .card-item {
        margin-bottom: 12px;
        font-size: 12px;
    }
    
    .card-label {
        font-weight: bold;
        color: #001f54;
        display: block;
        margin-bottom: 3px;
    }
    
    .card-value {
        color: #333;
        line-height: 1.5;
    }
    
    .value-elevated {
        color: #d9534f;
        font-weight: bold;
    }
    
    .value-critical {
        color: #d9534f;
        font-weight: bold;
        font-size: 14px;
    }
    
    /* Footer */
    .report-footer {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 2px solid #ddd;
        font-size: 9px;
        color: #666;
        line-height: 1.4;
    }
    
    /* Utility Classes */
    .text-orange { color: #ff8c00; }
    .text-navy { color: #001f54; }
    .text-red { color: #d9534f; }
    .text-muted { color: #999; }
    .mt-3 { margin-top: 15px; }
</style>
{% endblock %}

{% block content %}
<div class="preview-container">
    <!-- Action Bar -->
    <div class="preview-actions">
        <h1 class="preview-title">üìÑ Report Preview</h1>
        <div class="action-buttons">
            <a href="{% url 'reports:dashboard' %}" class="btn-back">
                ‚Üê Back to Reports
            </a>
            <a href="{% url 'reports:download' report.pk %}" class="btn-download">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
                Download PDF
            </a>
        </div>
    </div>
    
    <!-- Report Display -->
    <div class="report-display">
        <div class="report-container">
            <div class="content-area">
                <!-- HEADER -->
                <div class="report-header">
                    <h1 class="report-title">{{ title|default:"Patient Summary Report" }}</h1>
                    <div class="generated-date">Generated: {{ generated_at|date:"m/d/Y" }}</div>
                </div>
                
                <!-- PATIENT INFO CARD -->
                {% if data.patient_info %}
                <div class="patient-card">
                    <div class="icon-circle">üë§</div>
                    <div class="patient-details">
                        <div class="patient-name">Name: {{ data.patient_info.name|default:"Unknown Patient" }}</div>
                        <div class="patient-meta">Age: {{ data.patient_info.age|default:"N/A" }}</div>
                    </div>
                    <div class="patient-ids">
                        <div><strong>Patient ID:</strong> {{ data.patient_info.mrn|default:"N/A" }}</div>
                        <div><strong>DOB:</strong> {{ data.patient_info.date_of_birth|date:"m/d/Y"|default:"N/A" }}</div>
                    </div>
                </div>
                {% endif %}
                
                <!-- DIAGNOSIS LIST SECTION -->
                <div class="section-with-icon">
                    <div class="section-icon-header">
                        <div class="section-icon">ü©∫</div>
                        <h2 class="section-title">Diagnosis List</h2>
                    </div>
                    
                    {% if data.clinical_summary.conditions %}
                    <ul class="diagnosis-list">
                        {% for condition in data.clinical_summary.conditions %}
                        <li class="diagnosis-item">
                            {% if condition.codes and condition.codes.0.code %}
                            <span class="diagnosis-code">{{ condition.codes.0.code }}</span> ‚Äì 
                            {% endif %}
                            <span class="{% if condition.status == 'active' %}diagnosis-name{% else %}diagnosis-inactive{% endif %}">
                                {{ condition.display_name }}
                            </span>
                            {% if condition.severity %}
                            <span class="text-muted">({{ condition.severity }})</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted" style="font-style: italic;">No diagnoses recorded</p>
                    {% endif %}
                </div>
                
                <!-- HOSPITALIZATIONS SECTION -->
                <div class="section-with-icon">
                    <div class="section-icon-header">
                        <div class="section-icon">üè•</div>
                        <h2 class="section-title">Hospitalizations</h2>
                    </div>
                    
                    {% if data.clinical_summary.encounters %}
                    <ul class="hospitalization-list">
                        {% for encounter in data.clinical_summary.encounters %}
                        <li>
                            <span class="hosp-date">
                                {% if encounter.period.start %}{{ encounter.period.start|date:"m/d/Y" }}{% endif %}:
                            </span>
                            {{ encounter.class|default:"Visit" }}
                            {% if encounter.reason %}
                                - {% for r in encounter.reason|slice:":1" %}{{ r.display|default:r.code }}{% endfor %}
                            {% endif %}
                            {% if encounter.location %}
                                at {% for loc in encounter.location|slice:":1" %}{{ loc }}{% endfor %}
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted" style="font-style: italic;">No hospitalizations recorded</p>
                    {% endif %}
                </div>
                
                <!-- LABS & VITALS - CARD GRID -->
                <div class="section-with-icon">
                    <div class="section-icon-header">
                        <div class="section-icon">üî¨</div>
                        <h2 class="section-title">Laboratory Results</h2>
                    </div>
                    
                    <div class="card-grid">
                        <!-- LABS CARD -->
                        <div class="info-card">
                            <div class="card-header">
                                <div class="card-icon">üíâ</div>
                                Laboratory Results
                            </div>
                            <div class="card-body">
                                {% if data.clinical_summary.observations %}
                                    {% for obs in data.clinical_summary.observations|slice:":6" %}
                                    <div class="card-item">
                                        <span class="card-label">{{ obs.display_name }}</span>
                                        <div class="card-value {% if obs.interpretation == 'High' or obs.interpretation == 'Critical' %}value-elevated{% endif %}">
                                            {% if obs.effective_date %}{{ obs.effective_date|date:"m/d/Y" }}: {% endif %}
                                            <strong>{{ obs.value|default:"‚Äî" }}</strong>
                                            {% if obs.unit %} {{ obs.unit }}{% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                <p class="text-muted" style="font-style: italic;">No lab results available</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- VITALS CARD -->
                        <div class="info-card">
                            <div class="card-header">
                                <div class="card-icon">‚ù§Ô∏è</div>
                                Vital Signs
                            </div>
                            <div class="card-body">
                                {% if data.clinical_summary.observations %}
                                    {% for obs in data.clinical_summary.observations|slice:"6:12" %}
                                    <div class="card-item">
                                        <span class="card-label">{{ obs.display_name }}</span>
                                        <div class="card-value {% if obs.interpretation == 'High' or obs.interpretation == 'Critical' %}value-critical{% endif %}">
                                            {% if obs.effective_date %}{{ obs.effective_date|date:"m/d/Y" }}:<br>{% endif %}
                                            <strong class="{% if obs.interpretation == 'High' %}text-red{% endif %}">
                                                {{ obs.value|default:"‚Äî" }}
                                                {% if obs.unit %} {{ obs.unit }}{% endif %}
                                            </strong>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                <p class="text-muted" style="font-style: italic;">No vital signs recorded</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- MEDICATIONS SECTION -->
                <div class="section-with-icon mt-3">
                    <div class="section-icon-header">
                        <div class="section-icon">üíä</div>
                        <h2 class="section-title">Current Medications</h2>
                    </div>
                    
                    {% if data.clinical_summary.medications %}
                    <ul class="hospitalization-list">
                        {% for med in data.clinical_summary.medications %}
                        <li>
                            <strong>{{ med.display_name }}</strong>
                            {% if med.dosage %}
                                ‚Äì {% for dose in med.dosage|slice:":1" %}
                                    {% if dose.dose %}{{ dose.dose }}{% endif %}
                                    {% if dose.route %} {{ dose.route }}{% endif %}
                                    {% if dose.frequency %}, {{ dose.frequency }}{% endif %}
                                {% endfor %}
                            {% endif %}
                            <span class="text-muted">
                                ({{ med.status|default:"Active" }})
                            </span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted" style="font-style: italic;">No medications recorded</p>
                    {% endif %}
                </div>
                
                <!-- PROCEDURES SECTION -->
                <div class="section-with-icon mt-3">
                    <div class="section-icon-header">
                        <div class="section-icon">ü©ª</div>
                        <h2 class="section-title">Procedures</h2>
                    </div>
                    
                    {% if data.clinical_summary.procedures %}
                    <ul class="hospitalization-list">
                        {% for proc in data.clinical_summary.procedures %}
                        <li>
                            <span class="hosp-date">
                                {% if proc.performed_date %}{{ proc.performed_date|date:"m/d/Y" }}{% endif %}:
                            </span>
                            <strong>{{ proc.display_name }}</strong>
                            {% if proc.outcome %} ‚Äì {{ proc.outcome }}{% endif %}
                            <span class="text-muted">({{ proc.status|default:"Completed" }})</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted" style="font-style: italic;">No procedures recorded</p>
                    {% endif %}
                </div>
                
                <!-- FOOTER -->
                <div class="report-footer">
                    <p><strong>Disclaimer:</strong> This report is generated from structured clinical data for informational purposes only. 
                    It contains PHI and should be handled in accordance with HIPAA regulations. 
                    All data is proprietary to the healthcare institution and is intended for authorized personnel only.</p>
                    <p style="margin-top: 10px;"><em>Generated: {{ generated_at|date:"F d, Y g:i A" }}</em></p>
                </div>
            </div>
            
            <!-- NAVY SIDEBAR -->
            <div class="navy-sidebar"></div>
        </div>
    </div>
</div>
{% endblock %}

