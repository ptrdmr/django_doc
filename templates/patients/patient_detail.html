{% extends "base.html" %}
{% load static %}

{% block title %}{{ patient.first_name }} {{ patient.last_name }} - Patient Details{% endblock %}

{% block breadcrumbs %}
<nav class="flex mb-6" aria-label="Breadcrumb">
    <ol class="flex items-center space-x-2 text-sm">
        <li>
            <a href="{% url 'home' %}" class="text-blue-600 hover:text-blue-800 transition-colors">
                Home
            </a>
        </li>
        <li class="flex items-center">
            <svg class="w-4 h-4 text-gray-400 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
            <a href="{% url 'patients:list' %}" class="text-blue-600 hover:text-blue-800 transition-colors">
                Patients
            </a>
        </li>
        <li class="flex items-center">
            <svg class="w-4 h-4 text-gray-400 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
            <span class="text-gray-700 font-medium">{{ patient.first_name }} {{ patient.last_name }}</span>
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="p-6">
    <!-- Patient Header -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
            <div class="flex items-center space-x-4 mb-4 lg:mb-0">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                    <span class="text-blue-600 font-bold text-xl">
                        {{ patient.first_name|first }}{{ patient.last_name|first }}
                    </span>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">
                        {{ patient.first_name }} {{ patient.last_name }}
                    </h1>
                    <p class="text-gray-600">MRN: {{ patient.mrn }}</p>
                    <p class="text-gray-500 text-sm">
                        Patient ID: {{ patient.id|truncatechars:8 }}
                    </p>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex space-x-3">
                <a href="{% url 'patients:edit' patient.pk %}" 
                   class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Edit Patient
                </a>
                {% if debug %}
                <a href="{% url 'patients:delete' patient.pk %}" 
                   class="inline-flex items-center px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Delete Patient
                </a>
                {% endif %}
                <button type="button" onclick="exportFHIR()" 
                        class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export FHIR
                </button>
            </div>
        </div>
    </div>

    <!-- Patient Information Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Demographics -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                Demographics
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                    <p class="text-sm text-gray-900">{{ patient.date_of_birth|date:"F j, Y" }}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                    <p class="text-sm text-gray-900">{{ patient.get_gender_display|default:"Not specified" }}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Created</label>
                    <p class="text-sm text-gray-900">{{ patient.created_at|date:"F j, Y g:i A" }}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Last Updated</label>
                    <p class="text-sm text-gray-900">{{ patient.updated_at|date:"F j, Y g:i A" }}</p>
                </div>
                {% if patient.ssn %}
                <div class="sm:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">SSN</label>
                    <p class="text-sm text-gray-900 font-mono">{{ patient.ssn }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- FHIR Data Summary -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                FHIR Data Summary
            </h2>
            <div class="space-y-3">
                {% if fhir_summary %}
                    {% for resource_type, resource_info in fhir_summary.items %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <span class="text-green-600 font-semibold text-xs">{{ resource_type|first }}</span>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">{{ resource_type }}</p>
                                <p class="text-xs text-gray-500">
                                    {% if resource_info.count == 1 %}
                                        1 resource
                                    {% else %}
                                        {{ resource_info.count }} resources
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <button type="button" onclick="viewFHIRResource('{{ resource_type }}')" 
                                class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                            View
                        </button>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center py-6">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p class="text-sm text-gray-500 mt-2">No FHIR data available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Patient Documents -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Documents ({{ patient_documents|length }})
        </h2>
        
        {% if patient_documents %}
        <div class="overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Document
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Uploaded
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for document in patient_documents %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-8 w-8">
                                    <div class="h-8 w-8 rounded bg-red-100 flex items-center justify-center">
                                        <svg class="h-4 w-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">
                                        {{ document.filename|truncatechars:40 }}
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        {{ document.file_size|filesizeformat }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                                {% if document.status == 'completed' %}bg-green-100 text-green-800
                                {% elif document.status == 'processing' %}bg-yellow-100 text-yellow-800
                                {% elif document.status == 'failed' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ document.get_status_display }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ document.uploaded_at|date:"M j, Y g:i A" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <a href="{% url 'documents:detail' document.pk %}" 
                               class="text-blue-600 hover:text-blue-900 transition-colors">
                                View Details
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No documents</h3>
            <p class="mt-1 text-sm text-gray-500">
                This patient's medical documents will appear here once uploaded and processed.
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Patient History Timeline -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
            <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Patient History Timeline
        </h2>
        
        {% if patient_history %}
        <div class="flow-root">
            <ul role="list" class="-mb-8">
                {% for history in patient_history %}
                <li>
                    <div class="relative pb-8">
                        {% if not forloop.last %}
                        <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>
                        {% endif %}
                        <div class="relative flex space-x-3">
                            <div>
                                <span class="h-8 w-8 rounded-full flex items-center justify-center ring-8 ring-white
                                    {% if history.action == 'created' %}bg-green-500
                                    {% elif history.action == 'updated' %}bg-blue-500
                                    {% elif history.action == 'fhir_append' %}bg-purple-500
                                    {% else %}bg-gray-500{% endif %}">
                                    {% if history.action == 'created' %}
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    {% elif history.action == 'updated' %}
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    {% elif history.action == 'fhir_append' %}
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    {% else %}
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4">
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ history.get_action_display }}</p>
                                    {% if history.notes %}
                                    <p class="text-sm text-gray-500 mt-1">{{ history.notes }}</p>
                                    {% endif %}
                                    {% if history.fhir_delta %}
                                    <div class="mt-2">
                                        <p class="text-xs text-gray-500 font-medium">FHIR Resources Added:</p>
                                        <div class="flex flex-wrap gap-1 mt-1">
                                            {% for resource in history.fhir_delta %}
                                            <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded">
                                                {{ resource.resourceType|default:"Unknown" }}
                                            </span>
                                            {% endfor %}
                                        </div>
                                        <button type="button" onclick="viewHistoryDetails({{ history.id }})" 
                                                class="text-xs text-blue-600 hover:text-blue-800 mt-1">
                                            View Details
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="text-right text-sm whitespace-nowrap text-gray-500">
                                    <time datetime="{{ history.changed_at|date:'c' }}">
                                        {{ history.changed_at|date:"M j, Y" }}<br>
                                        {{ history.changed_at|date:"g:i A" }}
                                    </time>
                                    {% if history.changed_by %}
                                    <p class="text-xs text-gray-400 mt-1">
                                        by {{ history.changed_by.get_full_name|default:history.changed_by.username }}
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% else %}
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No history records</h3>
            <p class="mt-1 text-sm text-gray-500">
                This patient's activity history will appear here.
            </p>
        </div>
        {% endif %}
    </div>
</div>

<!-- FHIR Resource Modal -->
<div id="fhirModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900" id="modalTitle">FHIR Resource</h3>
            <button type="button" onclick="closeFHIRModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="modalContent" class="max-h-96 overflow-y-auto">
            <pre class="text-sm text-gray-800 whitespace-pre-wrap"></pre>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// FHIR data for JavaScript access
const fhirData = {{ patient.encrypted_fhir_bundle|safe }};
const patientId = '{{ patient.id }}';

function viewFHIRResource(resourceType) {
    const modal = document.getElementById('fhirModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    
    modalTitle.textContent = `FHIR ${resourceType} Resources`;
    
    // Extract resources of the specified type from FHIR Bundle
    const resources = [];
    if (fhirData && fhirData.entry) {
        for (const entry of fhirData.entry) {
            if (entry.resource && entry.resource.resourceType === resourceType) {
                resources.push(entry.resource);
            }
        }
    }
    
    if (resources.length > 0) {
        modalContent.innerHTML = `<pre class="text-sm text-gray-800 whitespace-pre-wrap">${JSON.stringify(resources, null, 2)}</pre>`;
    } else {
        modalContent.innerHTML = '<p class="text-gray-500">No resources found for this type.</p>';
    }
    
    modal.classList.remove('hidden');
}

function viewHistoryDetails(historyId) {
    // TODO: Implement history details modal
    // For now, just show an alert
    alert('History details modal not implemented yet. History ID: ' + historyId);
}

function closeFHIRModal() {
    const modal = document.getElementById('fhirModal');
    modal.classList.add('hidden');
}

function exportFHIR() {
    if (!fhirData || !fhirData.entry || fhirData.entry.length === 0) {
        alert('No FHIR data available to export.');
        return;
    }
    
    // Create a blob with the FHIR data
    const blob = new Blob([JSON.stringify(fhirData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    // Create a temporary link and click it to download
    const a = document.createElement('a');
    a.href = url;
    a.download = `patient-${patientId}-fhir-data.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Close modal when clicking outside
document.getElementById('fhirModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeFHIRModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeFHIRModal();
    }
});
</script>
{% endblock %} 